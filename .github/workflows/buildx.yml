name: test buildx

on:
  workflow_dispatch:
jobs: 
  build: 
    runs-on: gha-runner-actions-test
    container:
      image: rockylinux:9
    steps: 
    - name: checkout code
      uses: actions/checkout@v2
      env:
        GITHUB_TOKEN: ${{ github.token }}
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64
        driver: remote
        endpoint: tcp://buildkitd.arc-systems.svc.ml-cluster.local:1234
    - name: Build
#      uses: redhat-actions/buildah-build@v2
#      with:
#        image: demo
#        tags: ${{ github.sha }}
#        containerfiles: |
#          containers/Dockerfile
      uses: docker/build-push-action@v6
      with:
        push: false
        file: containers/Dockerfile
        cache-from: "type=s3,endpoint_url=http://k101.k8s.ucar.edu,bucket=buildx,region=default,access_key_id=${{ secrets.buildx_access_key }},secret_access_key=${{ secrets.buildx_secret_key }}"
        cache-to: "type=s3,endpoint_url=http://k101.k8s.ucar.edu,bucket=buildx,region=default,access_key_id=${{ secrets.buildx_access_key }},secret_access_key=${{ secrets.buildx_secret_key }}"
